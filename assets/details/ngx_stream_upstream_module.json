[
[4,"upstream","Defines a group of servers. Servers can listen on different ports. In addition, servers listening on TCP and UNIX-domain sockets can be mixed.","<p>Defines a group of servers. Servers can listen on different ports. In addition, servers listening on TCP and UNIX-domain sockets can be mixed.</p><p>Example:</p><blockquote class=\"example\"><pre>upstream backend {\n    server backend1.example.com:12345 weight=5;\n    server 127.0.0.1:12345            max_fails=3 fail_timeout=30s;\n    server unix:/tmp/backend2;\n    server backend3.example.com:12345 resolve;\n\n    server backup1.example.com:12345  backup;\n}\n</pre></blockquote><p>By default, connections are distributed between the servers using a weighted round-robin balancing method. In the above example, each 7 connections will be distributed as follows: 5 connections go to <code>backend1.example.com:12345</code> and one connection to each of the second and third servers. If an error occurs during communication with a server, the connection will be passed to the next server, and so on until all of the functioning servers will be tried. If communication with all servers fails, the connection will be closed.</p>",[],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>upstream</strong> <code>name</code> { ... }</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>stream</code><br></td></tr></tbody></table>"],
[4,"server","Defines the `address` and other `parameters` of a server. The address can be specified as a domain name or IP address with an obligatory port, or as a UNIX-domain socket path specified after the “`unix:`” prefix. A domain name that resolves to several IP addresses defines multiple servers at once.","<p>Defines the <code>address</code> and other <code>parameters</code> of a server. The address can be specified as a domain name or IP address with an obligatory port, or as a UNIX-domain socket path specified after the “<code>unix:</code>” prefix. A domain name that resolves to several IP addresses defines multiple servers at once.</p><p>The following parameters can be defined:</p><dl class=\"compact\"><dt id=\"weight\"><code>weight</code>=<code>number</code></dt><dd>sets the weight of the server, by default, 1.</dd><dt id=\"max_conns\"><code>max_conns</code>=<code>number</code></dt><dd>limits the maximum <code>number</code> of simultaneous connections to the proxied server (1.11.5). Default value is zero, meaning there is no limit. If the server group does not reside in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#zone\">shared memory</a>, the limitation works per each worker process.<blockquote class=\"note\">Prior to version 1.11.5, this parameter was available as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>.</blockquote></dd><dt id=\"max_fails\"><code>max_fails</code>=<code>number</code></dt><dd>sets the number of unsuccessful attempts to communicate with the server that should happen in the duration set by the <code>fail_timeout</code> parameter to consider the server unavailable for a duration also set by the <code>fail_timeout</code> parameter. By default, the number of unsuccessful attempts is set to 1. The zero value disables the accounting of attempts. Here, an unsuccessful attempt is an error or timeout while establishing a connection with the server.</dd><dt id=\"fail_timeout\"><code>fail_timeout</code>=<code>time</code></dt><dd>sets<ul class=\"compact\"><li>the time during which the specified number of unsuccessful attempts to communicate with the server should happen to consider the server unavailable;</li><li>and the period of time the server will be considered unavailable.</li></ul>By default, the parameter is set to 10 seconds.</dd><dt id=\"backup\"><code>backup</code></dt><dd>marks the server as a backup server. Connections to the backup server will be passed when the primary servers are unavailable.<blockquote class=\"note\">The parameter cannot be used along with the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#hash\">hash</a> and <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#random\">random</a> load balancing methods.</blockquote></dd><dt id=\"down\"><code>down</code></dt><dd>marks the server as permanently unavailable.</dd></dl><p>Additionally, the following parameters are available as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>:</p><dl class=\"compact\"><dt id=\"resolve\"><code>resolve</code></dt><dd>monitors changes of the IP addresses that correspond to a domain name of the server, and automatically modifies the upstream configuration without the need of restarting nginx. The server group must reside in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#zone\">shared memory</a>.<p>In order for this parameter to work, the <code>resolver</code> directive must be specified in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_core_module.html#resolver\">stream</a> block or in the corresponding <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#resolver\">upstream</a> block.</p></dd><dt id=\"service\"><code>service</code>=<code>name</code></dt><dd>enables resolving of DNS <a href=\"https://datatracker.ietf.org/doc/html/rfc2782\">SRV</a> records and sets the service <code>name</code> (1.9.13). In order for this parameter to work, it is necessary to specify the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#resolve\">resolve</a> parameter for the server and specify a hostname without a port number.<p>If the service name does not contain a dot (“<code>.</code>”), then the <a href=\"https://datatracker.ietf.org/doc/html/rfc2782\">RFC</a>-compliant name is constructed and the TCP protocol is added to the service prefix. For example, to look up the <code>_http._tcp.backend.example.com</code> SRV record, it is necessary to specify the directive:</p><blockquote class=\"example\"><pre>server backend.example.com service=http resolve;\n</pre></blockquote><p>If the service name contains one or more dots, then the name is constructed by joining the service prefix and the server name. For example, to look up the <code>_http._tcp.backend.example.com</code> and <code>server1.backend.example.com</code> SRV records, it is necessary to specify the directives:</p><blockquote class=\"example\"><pre>server backend.example.com service=_http._tcp resolve;\nserver example.com service=server1.backend resolve;\n</pre></blockquote><p></p><p>Highest-priority SRV records (records with the same lowest-number priority value) are resolved as primary servers, the rest of SRV records are resolved as backup servers. If the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#backup\">backup</a> parameter is specified for the server, high-priority SRV records are resolved as backup servers, the rest of SRV records are ignored.</p></dd><dt id=\"slow_start\"><code>slow_start</code>=<code>time</code></dt><dd>sets the <code>time</code> during which the server will recover its weight from zero to a nominal value, when unhealthy server becomes <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_hc_module.html#health_check\">healthy</a>, or when the server becomes available after a period of time it was considered <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#fail_timeout\">unavailable</a>. Default value is zero, i.e. slow start is disabled.<blockquote class=\"note\">The parameter cannot be used along with the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#hash\">hash</a> and <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#random\">random</a> load balancing methods.</blockquote></dd></dl><blockquote class=\"note\">If there is only a single server in a group, <code>max_fails</code>, <code>fail_timeout</code> and <code>slow_start</code> parameters are ignored, and such a server will never be considered unavailable.</blockquote>",["If there is only a single server in a group, `max_fails`, `fail_timeout` and `slow_start` parameters are ignored, and such a server will never be considered unavailable."],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>server</strong> <code>address</code> [<code>parameters</code>];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table>"],
[4,"zone","Defines the `name` and `size` of the shared memory zone that keeps the group’s configuration and run-time state that are shared between worker processes. Several groups may share the same zone. In this case, it is enough to specify the `size` only once.","<p>Defines the <code>name</code> and <code>size</code> of the shared memory zone that keeps the group’s configuration and run-time state that are shared between worker processes. Several groups may share the same zone. In this case, it is enough to specify the <code>size</code> only once.</p><p>Additionally, as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>, such groups allow changing the group membership or modifying the settings of a particular server without the need of restarting nginx. The configuration is accessible via the <a href=\"https://nginx.org/en/docs/http/ngx_http_api_module.html\">API</a> module (1.13.3).</p><blockquote class=\"note\">Prior to version 1.13.3, the configuration was accessible only via a special location handled by <a href=\"https://nginx.org/en/docs/http/ngx_http_upstream_conf_module.html#upstream_conf\">upstream_conf</a>.</blockquote>",["Prior to version 1.13.3, the configuration was accessible only via a special location handled by [upstream\\_conf](https://nginx.org/en/docs/http/ngx_http_upstream_conf_module.html#upstream_conf)."],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>zone</strong> <code>name</code> [<code>size</code>];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table>"],
[4,"state","Specifies a `file` that keeps the state of the dynamically configurable group.","<p>Specifies a <code>file</code> that keeps the state of the dynamically configurable group.</p><p>Examples:</p><blockquote class=\"example\"><pre>state /var/lib/nginx/state/servers.conf; # path for Linux\nstate /var/db/nginx/state/servers.conf;  # path for FreeBSD\n</pre></blockquote><p>The state is currently limited to the list of servers with their parameters. The file is read when parsing the configuration and is updated each time the upstream configuration is <a href=\"https://nginx.org/en/docs/http/ngx_http_api_module.html#stream_upstreams_stream_upstream_name_servers_\">changed</a>. Changing the file content directly should be avoided. The directive cannot be used along with the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#server\">server</a> directive.</p><blockquote class=\"note\">Changes made during <a href=\"https://nginx.org/en/docs/control.html#reconfiguration\">configuration reload</a> or <a href=\"https://nginx.org/en/docs/control.html#upgrade\">binary upgrade</a> can be lost.</blockquote><blockquote class=\"note\">This directive is available as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>.</blockquote>",["Changes made during [configuration reload](https://nginx.org/en/docs/control.html#reconfiguration) or [binary upgrade](https://nginx.org/en/docs/control.html#upgrade) can be lost.","This directive is available as part of our [commercial subscription](http://nginx.com/products/)."],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>state</strong> <code>file</code>;</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table><p>This directive appeared in version 1.9.7.</p>"],
[4,"hash","Specifies a load balancing method for a server group where the client-server mapping is based on the hashed `key` value. The `key` can contain text, variables, and their combinations (1.11.2). Usage example:","<p>Specifies a load balancing method for a server group where the client-server mapping is based on the hashed <code>key</code> value. The <code>key</code> can contain text, variables, and their combinations (1.11.2). Usage example:</p><blockquote class=\"example\"><pre>hash $remote_addr;\n</pre></blockquote><p>Note that adding or removing a server from the group may result in remapping most of the keys to different servers. The method is compatible with the <a href=\"https://metacpan.org/pod/Cache::Memcached\">Cache::Memcached</a> Perl library.</p><p>If the <code>consistent</code> parameter is specified, the <a href=\"https://www.metabrew.com/article/libketama-consistent-hashing-algo-memcached-clients\">ketama</a> consistent hashing method will be used instead. The method ensures that only a few keys will be remapped to different servers when a server is added to or removed from the group. This helps to achieve a higher cache hit ratio for caching servers. The method is compatible with the <a href=\"https://metacpan.org/pod/Cache::Memcached::Fast\">Cache::Memcached::Fast</a> Perl library with the <code>ketama_points</code> parameter set to 160.</p>",[],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>hash</strong> <code>key</code> [<code>consistent</code>];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table>"],
[4,"least_conn","Specifies that a group should use a load balancing method where a connection is passed to the server with the least number of active connections, taking into account weights of servers. If there are several such servers, they are tried in turn using a weighted round-robin balancing method.","<p>Specifies that a group should use a load balancing method where a connection is passed to the server with the least number of active connections, taking into account weights of servers. If there are several such servers, they are tried in turn using a weighted round-robin balancing method.</p>",[],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>least_conn</strong>;</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table>"],
[4,"least_time","Specifies that a group should use a load balancing method where a connection is passed to the server with the least average time and least number of active connections, taking into account weights of servers. If there are several such servers, they are tried in turn using a weighted round-robin balancing method.","<p>Specifies that a group should use a load balancing method where a connection is passed to the server with the least average time and least number of active connections, taking into account weights of servers. If there are several such servers, they are tried in turn using a weighted round-robin balancing method.</p><p>If the <code>connect</code> parameter is specified, time to <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_connect_time\">connect</a> to the upstream server is used. If the <code>first_byte</code> parameter is specified, time to receive the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_first_byte_time\">first byte</a> of data is used. If the <code>last_byte</code> is specified, time to receive the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_session_time\">last byte</a> of data is used. If the <code>inflight</code> parameter is specified (1.11.6), incomplete connections are also taken into account.</p><blockquote class=\"note\">Prior to version 1.11.6, incomplete connections were taken into account by default.</blockquote><blockquote class=\"note\">This directive is available as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>.</blockquote>",["Prior to version 1.11.6, incomplete connections were taken into account by default.","This directive is available as part of our [commercial subscription](http://nginx.com/products/)."],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>least_time</strong> <code>connect</code> | <code>first_byte</code> | <code>last_byte</code> [<code>inflight</code>];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table>"],
[4,"random","Specifies that a group should use a load balancing method where a connection is passed to a randomly selected server, taking into account weights of servers.","<p>Specifies that a group should use a load balancing method where a connection is passed to a randomly selected server, taking into account weights of servers.</p><p>The optional <code>two</code> parameter instructs nginx to randomly select <a href=\"https://homes.cs.washington.edu/~karlin/papers/balls.pdf\">two</a> servers and then choose a server using the specified <code>method</code>. The default method is <code>least_conn</code> which passes a connection to a server with the least number of active connections.</p>",[],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>random</strong> [<code>two</code> [<code>method</code>]];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table><p>This directive appeared in version 1.15.1.</p>"],
[4,"resolver","Configures name servers used to resolve names of upstream servers into addresses, for example:","<p>Configures name servers used to resolve names of upstream servers into addresses, for example:</p><blockquote class=\"example\"><pre>resolver 127.0.0.1 [::1]:5353;\n</pre></blockquote><p>The address can be specified as a domain name or IP address, with an optional port. If port is not specified, the port 53 is used. Name servers are queried in a round-robin fashion.</p>",[],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>resolver</strong> <code>address</code> ... [<code>valid</code>=<code>time</code>] [<code>ipv4</code>=<code>on</code>|<code>off</code>] [<code>ipv6</code>=<code>on</code>|<code>off</code>] [<code>status_zone</code>=<code>zone</code>];</code><br></td></tr><tr><th>Default:</th><td>—</td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table><p>This directive appeared in version 1.17.5.</p>"],
[4,"resolver_timeout","Sets a timeout for name resolution, for example:","<p>Sets a timeout for name resolution, for example:</p><blockquote class=\"example\"><pre>resolver_timeout 5s;\n</pre></blockquote><blockquote class=\"note\">This directive is available as part of our <a href=\"http://nginx.com/products/\">commercial subscription</a>.</blockquote>",["This directive is available as part of our [commercial subscription](http://nginx.com/products/)."],"<table ><tbody><tr><th>Syntax:</th><td><code><strong>resolver_timeout</strong> <code>time</code>;</code><br></td></tr><tr><th>Default:</th><td><pre>resolver_timeout 30s;</pre></td></tr><tr><th>Context:</th><td><code>upstream</code><br></td></tr></tbody></table><p>This directive appeared in version 1.17.5.</p>"],
[5,"<p>The <code>ngx_stream_upstream_module</code> module supports the following embedded variables:</p><dl class=\"compact\"><dt id=\"var_upstream_addr\"><code>$upstream_addr</code></dt><dd>keeps the IP address and port, or the path to the UNIX-domain socket of the upstream server (1.11.4). If several servers were contacted during proxying, their addresses are separated by commas, e.g. “<code>192.168.1.1:12345, 192.168.1.2:12345, unix:/tmp/sock</code>”. If a server cannot be selected, the variable keeps the name of the server group.</dd><dt id=\"var_upstream_bytes_received\"><code>$upstream_bytes_received</code></dt><dd>number of bytes received from an upstream server (1.11.4). Values from several connections are separated by commas like addresses in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_addr\">$upstream_addr</a> variable.</dd><dt id=\"var_upstream_bytes_sent\"><code>$upstream_bytes_sent</code></dt><dd>number of bytes sent to an upstream server (1.11.4). Values from several connections are separated by commas like addresses in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_addr\">$upstream_addr</a> variable.</dd><dt id=\"var_upstream_connect_time\"><code>$upstream_connect_time</code></dt><dd>time to connect to the upstream server (1.11.4); the time is kept in seconds with millisecond resolution. Times of several connections are separated by commas like addresses in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_addr\">$upstream_addr</a> variable.</dd><dt id=\"var_upstream_first_byte_time\"><code>$upstream_first_byte_time</code></dt><dd>time to receive the first byte of data (1.11.4); the time is kept in seconds with millisecond resolution. Times of several connections are separated by commas like addresses in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_addr\">$upstream_addr</a> variable.</dd><dt id=\"var_upstream_session_time\"><code>$upstream_session_time</code></dt><dd>session duration in seconds with millisecond resolution (1.11.4). Times of several connections are separated by commas like addresses in the <a href=\"https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html#var_upstream_addr\">$upstream_addr</a> variable.</dd></dl>"]
]